# #!/usr/bin/env python3
# modules/port_manager.py
# –°–∫—Ä–∏–ø—Ç –Ω–∞ Python –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–Ω—è—Ç –ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ—Ä—Ç, –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–π—Å—Ç–≤–∏—è: 
# —É–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π –ø–æ—Ä—Ç, –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é. 
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `psutil` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö. 
# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –≤—ã–≤–æ–¥–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

import psutil

def handle_port_conflict(port):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç, –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    
    :param port: –ù–æ–º–µ—Ä –ø–æ—Ä—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    :return: –°—Ç—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è ("kill", "restart", "exit")
    """
    try:
        for conn in psutil.net_connections():
            if conn.laddr.port == port:
                pid = conn.pid
                print(" ")
                print(f"\033[1m ‚ö†Ô∏è  –ü–æ—Ä—Ç {port} —É–∂–µ –∑–∞–Ω—è—Ç \n ‚ö†Ô∏è  –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Å PID üÜî {pid}.\033[0m")

                if pid:
                    process_name = psutil.Process(pid).name()
                    print("")
                    print(f" –ü—Ä–æ—Ü–µ—Å—Å, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π –ø–æ—Ä—Ç: {process_name}\n üî™ (PID {pid}).")
                else:
                    print(" –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π –ø–æ—Ä—Ç.")

                print("\n –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:\n")
                print(f" üî™ 1. –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å (PID {pid})")
                print(" üîÑ 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç —Å–Ω–æ–≤–∞")
                print(" üö™ 3. –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
                print("")
                choice = input(" –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ [1/2/3]: ").strip()
                
                if choice == "1" and pid:
                    try:
                        os.kill(pid, 9)
                        print(f" ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å {process_name} (PID {pid}) –±—ã–ª üî™ –∑–∞–≤–µ—Ä—à–µ–Ω ü©∏.")
                        return "kill"  # –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
                    except Exception as e:
                        print(f" ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞: {e}")
                elif choice == "2":
                    print(" üîÑ –ü—ã—Ç–∞—é—Å—å —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç...\n")
                    return "restart"  # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Ä—Ç–∞ —Å–Ω–æ–≤–∞
                elif choice == "3":
                    print(" üîô –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.\n")
                    return "exit"  # –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                else:
                    print("")
                    print(" ‚ö†Ô∏è  –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä. \n –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é.")
                    return "exit"  # –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        print(f" ‚úÖ –ü–æ—Ä—Ç {port} —Å–≤–æ–±–æ–¥–µ–Ω. (port_manager.py)")
        return "ok"
    except Exception as e:
        print(f" ‚ùå –û—à–∏–±–∫–∞: {e}")
        return "exit"  # –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
