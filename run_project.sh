#!/bin/bash
# run_project.sh
## –£—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–π –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–µ–∫—Ç–∞ wg_qr_generator
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

# –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
GITHUB_REPO="https://github.com/licht8/wg_qr_generator.git"
PROJECT_DIR="wg_qr_generator"
VENV_DIR="venv"
WIREGUARD_INSTALL_SCRIPT="wireguard-install.sh"
WIREGUARD_BINARY="/usr/bin/wg"

echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ wg_qr_generator ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Git
if ! command -v git &>/dev/null; then
  echo "‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python 3.8+
if ! command -v python3 &>/dev/null; then
  echo "‚ùå Python3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Python3
PYTHON_VERSION=$(python3 -c 'import sys; print(sys.version_info >= (3, 8))')
if [ "$PYTHON_VERSION" != "True" ]; then
  echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Python –≤–µ—Ä—Å–∏–∏ 3.8 –∏–ª–∏ –≤—ã—à–µ. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –≤–µ—Ä—Å–∏—é."
  exit 1
else
  echo "‚úÖ Python –≤–µ—Ä—Å–∏–∏ 3.8 –∏–ª–∏ –≤—ã—à–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω."
fi



# –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
cd ..
if [ ! -d "$PROJECT_DIR" ]; then
  echo "üîÑ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
  git clone "$GITHUB_REPO"
else
  echo "üîÑ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –û–±–Ω–æ–≤–ª—è–µ–º..."
  git -C "$PROJECT_DIR" pull
fi

# –°–æ–∑–¥–∞–µ–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ ! -d "$VENV_DIR" ]; then
  echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
  python3 -m venv "$VENV_DIR"
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source "$VENV_DIR/bin/activate"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install --upgrade pip
if [ -f "$PROJECT_DIR/requirements.txt" ]; then
  pip install -r "$PROJECT_DIR/requirements.txt"
else
  echo "‚ö†Ô∏è –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–µ–∫—Ç."
fi

echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ WireGuard
function check_wireguard_installed() {
  if [ -f "$WIREGUARD_BINARY" ]; then
    echo "True"
  else
    echo "False"
  fi
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard
function install_wireguard() {
  if [ -f "$WIREGUARD_INSTALL_SCRIPT" ]; then
    echo "üîß –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ WireGuard..."
    bash "$WIREGUARD_INSTALL_SCRIPT"
  else
    echo "‚ùå –°–∫—Ä–∏–ø—Ç $WIREGUARD_INSTALL_SCRIPT –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ª–æ–∂–∏—Ç–µ –µ–≥–æ –≤ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
  fi
}

# –£–¥–∞–ª–µ–Ω–∏–µ WireGuard
function remove_wireguard() {
  echo "‚ùå –£–¥–∞–ª–µ–Ω–∏–µ WireGuard..."
  yum remove wireguard -y 2>/dev/null || apt remove wireguard -y 2>/dev/null
}

# –ú–µ–Ω—é –¥–ª—è –∑–∞–ø—É—Å–∫–∞
while true; do
  WIREGUARD_STATUS=$(check_wireguard_installed)
  echo "================== –ú–µ–Ω—é =================="
  if [ "$WIREGUARD_STATUS" == "True" ]; then
    echo "‚úÖ WireGuard —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "3. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WireGuard ‚ôªÔ∏è"
    echo "4. –£–¥–∞–ª–∏—Ç—å WireGuard üóëÔ∏è"
  else
    echo "3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WireGuard ‚öôÔ∏è"
  fi
  echo "1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
  echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç (main.py)"
  echo "0. –í—ã—Ö–æ–¥"
  echo "=========================================="
  read -rp "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: " choice
  case $choice in
    1)
      echo "üîç –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
      pytest "$PROJECT_DIR"
      ;;
    2)
      read -rp "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (nickname): " nickname
      python3 "$PROJECT_DIR/main.py" "$nickname"
      ;;
    3)
      if [ "$WIREGUARD_STATUS" == "True" ]; then
        install_wireguard
      else
        install_wireguard
      fi
      ;;
    4)
      if [ "$WIREGUARD_STATUS" == "True" ]; then
        remove_wireguard
      else
        echo "‚ö†Ô∏è WireGuard –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
      fi
      ;;
    0)
      echo "üëã –í—ã—Ö–æ–¥. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!"
      deactivate
      exit 0
      ;;
    *)
      echo "‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
      ;;
  esac
done
