#!/usr/bin/env python3
# menu.py
## –ú–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º wg_qr_generator
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤, –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è WireGuard.

import os
import subprocess

WIREGUARD_BINARY = "/usr/bin/wg"
WIREGUARD_INSTALL_SCRIPT = "wireguard-install.sh"
CONFIG_DIR = "user/data"
TEST_USER = "test_user"

def check_wireguard_installed():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ WireGuard."""
    return os.path.isfile(WIREGUARD_BINARY)

def install_wireguard():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard."""
    if os.path.isfile(WIREGUARD_INSTALL_SCRIPT):
        print("üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard...")
        subprocess.run(["bash", WIREGUARD_INSTALL_SCRIPT])
    else:
        print(f"‚ùå –°–∫—Ä–∏–ø—Ç {WIREGUARD_INSTALL_SCRIPT} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ª–æ–∂–∏—Ç–µ –µ–≥–æ –≤ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.")

def remove_wireguard():
    """–£–¥–∞–ª–µ–Ω–∏–µ WireGuard."""
    print("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ WireGuard...")
    subprocess.run(["yum", "remove", "wireguard", "-y"], stderr=subprocess.DEVNULL) or \
    subprocess.run(["apt", "remove", "wireguard", "-y"], stderr=subprocess.DEVNULL)

def ensure_test_config_exists():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."""
    config_path = os.path.join(CONFIG_DIR, f"{TEST_USER}.conf")
    if not os.path.exists(config_path):
        print("‚öôÔ∏è  –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
        subprocess.run(["python3", "main.py", TEST_USER])
        print(f"‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{TEST_USER}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")
    else:
        print(f"‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è '{TEST_USER}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

def show_menu():
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é."""
    while True:
        wireguard_installed = check_wireguard_installed()
        print("================== –ú–µ–Ω—é ==================")
        print("1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã")
        print("2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç (main.py)")
        if wireguard_installed:
            print("3. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WireGuard ‚ôªÔ∏è")
            print("4. –£–¥–∞–ª–∏—Ç—å WireGuard üóëÔ∏è")
        else:
            print("3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WireGuard ‚öôÔ∏è")
        print("0. –í—ã—Ö–æ–¥")
        print("==========================================")
        choice = input("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ").strip()
        if choice == "1":
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏
            ensure_test_config_exists()
            print("üîç –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...")
            subprocess.run(["pytest"])
        elif choice == "2":
            nickname = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (nickname): ").strip()
            subprocess.run(["python3", "main.py", nickname])
        elif choice == "3":
            install_wireguard()
        elif choice == "4":
            if wireguard_installed:
                remove_wireguard()
            else:
                print("‚ö†Ô∏è WireGuard –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
        elif choice == "0":
            print("üëã –í—ã—Ö–æ–¥. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            break
        else:
            print("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

if __name__ == "__main__":
    show_menu()
