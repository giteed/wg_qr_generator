### `main.py` и `main_registration_fields.py` — Полное Руководство

---

## Оглавление
1. [Введение](#введение)
2. [Описание файлов](#описание-файлов)
   - [Основной файл `main.py`](#основной-файл-mainpy)
   - [Модуль `main_registration_fields.py`](#модуль-main_registration_fieldspy)
3. [Пример конфигурации WireGuard](#пример-конфигурации-wireguard)
4. [Использование `main.py`](#использование-mainpy)
   - [Синтаксис запуска](#синтаксис-запуска)
   - [Параметры командной строки](#параметры-командной-строки)
   - [Примеры запуска](#примеры-запуска)
5. [Файлы конфигурации и базы данных](#файлы-конфигурации-и-базы-данных)

---

## Введение

Этот проект позволяет автоматизировать управление пользователями VPN WireGuard. Основной файл `main.py` отвечает за создание новых пользователей, генерацию их конфигураций, добавление их в серверную конфигурацию WireGuard и сохранение метаданных. 

Модуль `main_registration_fields.py` служит для стандартизации записи данных о пользователях и создания единого формата записи.

---

## Описание файлов

### Основной файл `main.py`

`main.py` выполняет следующие задачи:
1. Генерация приватных, публичных и пресекретных ключей для нового пользователя.
2. Назначение IP-адреса и создание клиентской конфигурации.
3. Генерация QR-кода для удобного подключения.
4. Добавление пользователя в конфигурацию сервера WireGuard.
5. Создание или обновление базы данных пользователей с подробной информацией.
6. Перезапуск WireGuard для применения новых настроек.

#### Основные функции:
- **`generate_config()`**: Генерирует конфигурацию нового пользователя и QR-код.
- **`restart_wireguard()`**: Перезапускает WireGuard для обновления настроек.
- **`load_existing_users()`**: Загружает текущую базу данных пользователей.
- **`is_user_in_server_config()`**: Проверяет наличие пользователя в серверной конфигурации.
- **`add_user_record()`**: (Заменена на вызов `create_user_record`) добавляет запись пользователя в базу данных.

---

### Модуль `main_registration_fields.py`

`main_registration_fields.py` содержит функцию `create_user_record`, которая создает стандартный формат записи о пользователе. Эта запись используется для базы данных и хранения информации о VPN-пользователях.

**Функция `create_user_record` выполняет следующие действия:**
- Генерация уникального идентификатора пользователя (UUID).
- Указание сроков действия учетной записи (30 дней по умолчанию).
- Заполнение всех полей данных, включая контактную информацию, ключи, IP-адрес, реферальные данные, состояние подписки и другую информацию.

Пример записи о пользователе:
```json
{
    "username": "JohnDoe",
    "user_id": "123e4567-e89b-12d3-a456-426614174000",
    "group": "guest",
    "created_at": "2024-11-27T12:00:00",
    "expires_at": "2024-12-27T12:00:00",
    "allowed_ips": "192.168.1.2/32",
    "public_key": "public_key_example",
    "preshared_key": "preshared_key_example",
    "qr_code_path": "/path/to/qr.png",
    "email": "john@example.com",
    "telegram_id": "123456789",
    "status": "active"
}
```

---

## Пример конфигурации WireGuard

Файл конфигурации для клиента (создается для каждого пользователя) может выглядеть следующим образом:

```ini
[Interface]
PrivateKey = ABCDEFGHIJKLMNOPQRSTUVXYZ1234567890
Address = 192.168.1.2/32
DNS = 1.1.1.1,8.8.8.8

[Peer]
PublicKey = ABCDEFGHIJKLMNOPQRSTUVXYZ1234567890
PresharedKey = ABCDEFGHIJKLMNOPQRSTUVXYZ1234567890
Endpoint = vpn.example.com:51820
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25
```

---

## Использование `main.py`

### Синтаксис запуска

```bash
python3 main.py <nickname> [email] [telegram_id]
```

### Параметры командной строки

1. **`<nickname>`** (обязательный): Никнейм нового пользователя. Используется как уникальный идентификатор.
2. **`[email]`** (опционально): Email-адрес пользователя.
3. **`[telegram_id]`** (опционально): Telegram ID пользователя.

### Примеры запуска

#### Создание пользователя с минимальными данными:
```bash
python3 main.py JohnDoe
```
*Результат:*
- Будет создан пользователь с ником `JohnDoe`.
- Конфигурационный файл будет сохранен в `settings.WG_CONFIG_DIR`.
- QR-код будет сохранен в `settings.QR_CODE_DIR`.

#### Создание пользователя с дополнительными данными:
```bash
python3 main.py JohnDoe john@example.com 123456789
```
*Результат:*
- В базу данных добавится информация о `email` и `telegram_id`.

---

## Файлы конфигурации и базы данных

### База данных пользователей

- Файл: `user/data/user_records.json`
- Хранит данные всех пользователей в формате JSON.
- При каждом добавлении пользователя файл обновляется.

### Конфигурации клиентов

- Путь: `settings.WG_CONFIG_DIR/<nickname>.conf`
- Содержит индивидуальный файл настройки VPN для клиента.

### QR-коды

- Путь: `settings.QR_CODE_DIR/<nickname>.png`
- Содержит QR-код для быстрой настройки клиента.

---

## Советы по использованию

1. **Перед добавлением нового пользователя** убедитесь, что сервер WireGuard запущен и настроен.
2. **Удаление пользователей** из базы данных или серверной конфигурации нужно делать вручную. Этот скрипт добавляет пользователей, но не удаляет.
3. **Для массового добавления** пользователей можно создать скрипт, который вызовет `main.py` несколько раз с разными параметрами.

---

## Примечания

- Все настройки, такие как директории для конфигураций и QR-кодов, находятся в файле `settings.py`.
- Логи работы скрипта выводятся в стандартный поток и включают уровни сообщений (`INFO`, `DEBUG`, `ERROR`).
- Скрипт требует запуска с правами администратора для изменения настроек WireGuard.

```markdown
python3 main.py --help
# Запустите эту команду, чтобы получить справку, если такая опция будет добавлена в будущем.
```
